<!doctype html>
<html lang="en">
<head>
    <title>Eurovote</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            height: 100vh;
        }

        body {
            font: 14px Open Sans, Segoe UI, Arial;
            background-color: rgb(7, 20, 52);
            background-image: url(bg.jpg);
            background-attachment: fixed;
            background-position: center center;
            background-size: cover;
            color: white;
            padding: 5px 20px;
        }

        a {
            color: black;
        }

        #msgs, #people {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        #msgs {
            position: fixed;
            top: 0;
            background: orange;
            left: 0;
            padding: 0 40px;
            width: 100%;
        }

        #people {
            padding: 5px 6px;
        }

        #people li {
            display: inline-block;
            padding: 0 10px;
            border-radius: 5px;
            box-shadow: 3px 2px 7px 0 rgba(0, 0, 0, 0.6);
            border: 2px solid #ffffff;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.06);
            font-weight: 500;
            margin: 0 10px 2px 0;
        }

        input, button, a.button {
            border-radius: 30px;
            box-shadow: 3px 2px 7px 0 rgba(0, 0, 0, 0.6);
            border: 2px solid #ffffff;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.06);
            font: 14px Open Sans, Segoe UI, Arial;
            font-weight: 500;
            padding: 2px 10px;
            text-decoration: none;
            outline: none;
        }

        button:hover, a.button:hover, input[type="submit"]:hover {
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        input::placeholder {
            font: 14px Open Sans, Segoe UI, Arial;
            font-weight: 500;
            color: white;
        }

        #login {
            text-align: center;
        }

        #loginForm {
            background: #ffffff2e;
            border-radius: 8px;
            backdrop-filter: blur(4px);
            text-align: center;
            padding: 20px;
            box-shadow: 0 0 1px 1px rgba(255, 255, 255, .5);
        }

        #loginForm h2 {
            margin: 0 0 20px 0;
        }

        .votelist thead tr {
            background-color: white;
            color: black;
            text-align: left;
        }

        .votelist thead a {
            color: black;
        }

        .votelist {
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
            box-shadow: 0 0 10px 0 rgba(0,0,0, .3);
        }

        .votelist tr, #vote tr::before {
            height: 45px;
            margin: 3px;
            background: rgba(244, 248, 255, 0.95);
            color: black;
        }

        .votelist td, .votelist th {
            vertical-align: middle;
            border-bottom: 1px solid #fff;
            padding: 2px 6px;
            width: inherit;
            word-break: break-word;
        }

        .votelist td.dragger {
            text-align: right;
            background: #ffffffc9;
            color: #071434;
            font-size: 22px;
            width: auto;
            cursor: n-resize;
        }

        .votelist td:first-child {
            word-break: keep-all;
            font-weight: 600;
            text-align: right;
        }

        .votelist img {
            height: 30px;
            border-radius: 50%;
        }

        .votelist div {
            display: inline-block;
        }

        .votelist tr.ui-state-highlight {
            background: #555 !important;
        }

        #vote tbody tr::before {
            content: " ";
            display: table-cell;
            border-bottom: 1px solid #f2f2f2;
            vertical-align: middle;
            padding: 2px 6px;
            background: #00000008;
            text-align: center;
            font-weight: bold;
            word-break: keep-all;
        }

        #vote tr:nth-child(2)::before {
            content: "12"
        }

        #vote tr:nth-child(3)::before {
            content: "10"
        }

        #vote tr:nth-child(4)::before {
            content: "8"
        }

        #vote tr:nth-child(5)::before {
            content: "7"
        }

        #vote tr:nth-child(6)::before {
            content: "6"
        }

        #vote tr:nth-child(7)::before {
            content: "5"
        }

        #vote tr:nth-child(8)::before {
            content: "4"
        }

        #vote tr:nth-child(9)::before {
            content: "3"
        }

        #vote tr:nth-child(10)::before {
            content: "2"
        }

        #vote tr:nth-child(11)::before {
            content: "1"
        }

        .center {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="row page2" id="page2" style="display: none">
    <div class="span2" id="msgs">
    </div>

    <a class="button" style="float:right" href="/dashboard" target="_blank">Show group results</a>

    <div class="span2">
        <ul id="people" class="unstyled"></ul>
    </div>

    <h1>Your vote</h1>
    <table id="vote" class="votelist">
        <thead>
        <tr>
            <th>Pts</th>
            <th>
                R/O
            </th>
            <th>
                Country
            </th>
            <th>
                Contestant
            </th>
            <th>
                Song
            </th>
            <th>
                &#8597;
            </th>
        </tr>
        </thead>
        <tbody>
        <tr class="ui-state-disabled">
            <td colspan="7" style="font-weight: normal; color: #444; text-align:center; font-size: 0.9em"><i>Drag the contestants to this table. Place the best act on top.</i></td>
        </tr>
        </tbody>
    </table>
    <h1>Votable acts</h1>
    <table id="votable" class="votelist"></table>

    <h2>Actions</h2>
    <button id="clearAll">Clear username and votes</button>
    <br><br>
</div>
<div class="row center">
    <div class="span5 offset2" id="login">
        <h1 style="font-weight: 300">Good evening Europe!</h1>
        <br>

        <h1>Join our voting for the<br><img
                src="https://static.eurovision.tv/dist/assets/images/esc/2022/logo-white.b7f11e66612fa8eae044..svg"
                alt="Eurovision Song Contest" width="300"></h1>

        <br>

        <form class="form-inline" id="loginForm">
            <h2>Enter your name to join the group.</h2>

            <input type="text" class="input-small" placeholder="Your name" id="name" autofocus style="margin-right: 4px">
            <input type="submit" name="join" id="join" value="Join" class="btn btn-primary">
        </form>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.2/jquery.ui.touch-punch.min.js"></script>

<script>
    const socket = io();
    const scoring = [12, 10, 8, 7, 6, 5, 4, 3, 2, 1];
    const messages = document.getElementById("msgs");

    let ready = false;
    let username = "";
    let sessionid = false;
    let UserId = false;

    function join(name) {
        if (name !== "") {
            UserId = (document.cookie.indexOf("UserId=") >= 0) ? getCookie("UserId") : "UID" + socket.id;
            socket.emit("join", UserId, name);
            username = name;
            sessionid = socket.id;
            ready = true;
            setCookie("UserId", UserId, 1);
            setCookie("UserName", username, 1);
            document.querySelector("#login").remove();
            document.querySelector("#page2").style.display = "block";
        }
    }

    document.querySelector("#clearAll").addEventListener("click", function () {
        deleteAllCookies();
        location.reload();
    });

    document.querySelector("#loginForm").addEventListener("submit", function (event) {
        event.preventDefault();
        join(document.querySelector("#name").value);
    });

    const updatesortable = function () {
        const scores = {};

        document.querySelectorAll("#vote tbody > tr:not(.ui-state-disabled)").forEach(function (tr, i) {
            if (i < scoring.length) {
                const score = tr.querySelector("td:first-child").textContent.trim();
                scores[score] = scoring[i];
            }
        })

        console.log(scores);
        socket.emit("vote", UserId, scores);
    }

    socket.on("init-votes", function (msg) {
        if (username !== "") {
            console.log("rejoin");
            socket.emit("rejoin", UserId, username, sessionid);
            sessionid = socket.id;
            updatesortable();
            return;
        }

        for (const act in msg) {
            document.querySelector("#votable").insertAdjacentHTML(
                'beforeend',
                "<tr class=\"bouger\" data-act=\"" + act + "\">\
						<td>" + act + "</td>\
						<td>" + msg[act]["country"] + "</td>\
						<td>" + msg[act]["contestant"] + "</td>\
						<td>" + msg[act]["song"] + "</td>\
						<td class=\"dragger\">&#8597;</td></tr>"
            );
        }

        $("#votable tbody").sortable({
            connectWith: ".votelist tbody",
            handle: 'td:last-child',
            dropOnEmpty: true,
            placeholder: "ui-state-highlight"
        }).disableSelection();

        $("#vote tbody").sortable({
            connectWith: ".votelist tbody",
            handle: 'td:last-child',
            dropOnEmpty: true,
            placeholder: "ui-state-highlight",
            items: "tr:not(.ui-state-disabled)",
            update: updatesortable
        }).disableSelection();

        if (document.cookie.indexOf("UserId=") >= 0) {
            console.log(getCookie("UserId"));
            join(getCookie("UserName"));
        }
    });

    socket.on("update-people", function (people) {
        if (ready) {
            const peopleElement = document.querySelector("#people");
            peopleElement.innerHTML = "";
            for (const person of people) {
                peopleElement.insertAdjacentHTML('beforeend', "<li>" + person + "</li>");
            }
        }
    });

    socket.on("init-scores", function (msg) {
        console.log("init scores", msg);
        const score = [];
        for (const act in msg) {
            score.push({key: act, value: msg[act]})
        }
        score.sort(function (a, b) {
            return b.value - a.value;
        });
        for (const tuple of score) {
            const votable = document.querySelector("#votable tr[data-act='" + tuple.key + "']");
            document.querySelector("#vote tbody").appendChild(votable);
        }
        updatesortable();
    });

    socket.on("disconnect", function () {
        messages.innerHTML = "Lost connection to the server";
    });

    socket.on('connect_timeout', () => {
        messages.innerHTML = "Are you still connected to the internet?";
    });

    socket.on("connect", function () {
        messages.innerHTML = "";
        console.log("established connection");
    });

    function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        const name = cname + "=";
        const decodedCookie = decodeURIComponent(document.cookie);
        const ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) === 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function deleteAllCookies() {
        const cookies = document.cookie.split(";");

        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
        }
    }
</script>
</body>
</html>
